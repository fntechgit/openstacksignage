<!DOCTYPE html>

<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>FNOpen Signage Dashboard</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/assets/favicon/manifest.json">
    <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">

    <script src="/dist/manifest.build.js"></script>
    <script src="/dist/config-admin.build.js"></script>

    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-bootgrid/1.3.1/jquery.bootgrid.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-bootgrid/1.3.1/jquery.bootgrid.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.6/moment-timezone-with-data.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/smalot-bootstrap-datetimepicker/2.4.4/css/bootstrap-datetimepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smalot-bootstrap-datetimepicker/2.4.4/js/bootstrap-datetimepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-serialize-object/2.5.0/jquery.serialize-object.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autosize.js/4.0.0/autosize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.18.1/URI.js"></script>

    <style>
        .navbar {
            margin-bottom: 3px;
            padding-right: 15px;
        }
        .navbar-text{
            margin-top: 17px;
            margin-bottom: 13px;
        }
        .connect {
            cursor: pointer;
        }
        .dashboard {
            padding-top: 20px;
            padding-bottom: 20px;
            margin-bottom: 20px;
            background-color: #edf2f7;
        }
        label {
            font-weight: 400;
        }
        #firebase-dialog .modal-dialog {
            width: 400px;
        }
        .bootgrid-table th, .bootgrid-table th:active, .bootgrid-table th:hover {
            background-color: #dedede;
        }
        table#filters td {
            padding: 0 10px;
            padding-bottom: 5px;
        }
        table#filters td button {
            margin-right: 5px;
            min-width: 80px;
        }
        input[type="search"] {
            -webkit-appearance: searchfield;
        }
        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: searchfield-cancel-button;
        }
        .eventColumn {
            width: 8%;
        }
        .titleColumn {
            width: 25%;
        }
        .speakersColumn {
            width: 15%;
        }
        .floorRoomColumn {
            width: 15%;
        }
        .screenLinkColumn {
            width: 15%;
        }
        .tagsColumn {
            width: 15%;
        }
        .dateColumn {
            width: 8%;
        }
        .wheel{
            width:30px;
        }
        .wheel-loading {
            animation: ani 2s infinite linear;
        }
        @keyframes ani {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(359deg);
            }
        }
        .grid-margin {
            width: calc(100% - 30px);
            max-width: calc(100% - 30px);
            margin-left: 15px;
        }
        .inline-space {
            margin-right: 10px;
        }
        .text-muted {
            font-size: 75%;
        }
	.navbar-brand .brand-logo img{
           width: 48px;
           height: 48px;
           border-radius: 50%;
           margin-top: -15px;
	}
	.navbar-brand .brand-title{
	   color: #333;
           font-weight: bold;		   
	   margin-left: 32px;
	}
    </style>
</head>

<body>
<div id="firebase-dialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="firebase dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Firebase Authentication</h4>
            </div>
            <form>
                <div class="modal-body">
                    <div class="form-group row">
                        <label for="username" class="col-md-3 col-form-label">Email</label>
                        <div class="col-md-9">
                            <input type="email" class="form-control" name="username" aria-describedby="firebase username" required/>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="password" class="col-md-3 col-form-label">Password</label>
                        <div class="col-md-9">
                            <input type="password" class="form-control" name="password" aria-describedby="firebase password" required/>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" aria-describedby="firevase login">Login</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="banner-dialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="message dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">New Message</h4>
            </div>
            <form>
                <div class="modal-body">
                    <input type="hidden" name="id" value="0">
                    <input type="hidden" name="enabled" value="1">
                    <input type="hidden" name="class_name" value="ScheduledSummitLocationBanner">
                    <div class="form-group">
                        <input type="text" class="form-control" name="title" aria-describedby="message title" placeholder="This is the message title. Required. (May be used on sign or only for reference)" required/>
                    </div>
                    <div class="form-group">
                        <textarea class="form-control" name="content" aria-describedby="message content" placeholder="This is the content of the message. Required." required></textarea>
                    </div>
                    <div class="form-group row">
                        <label for="banner-start" class="col-md-1 col-form-label">Start</label>
                        <div class="col-md-5">
                            <div class='input-group date' id="banner-start" aria-describedby="message start date" style="cursor: pointer;">
                                <input type='text' class="form-control" name="start_date" required/>
                                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                            </div>
                        </div>
                        <label for="banner-type" class="col-md-1 col-form-label">Type</label>
                        <div class="col-md-5">
                            <select class="form-control" id="banner-type" name="type" aria-describedby="message type">
                                <option selected value="Primary">Top message</option>
                                <option value="Secondary">Footer message</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="banner-end" class="col-md-1 col-form-label">End</label>
                        <div class="col-md-5">
                            <div class='input-group date' id="banner-end" aria-describedby="message end date" style="cursor: pointer;">
                                <input type='text' class="form-control" name="end_date" required/>
                                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" aria-describedby="message submit">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>
<nav class="navbar">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">
		    <span class="brand-logo"><img src="assets/images/signage-logo.png" /></span>
		    <span class="brand-title" >DIGITAL SIGNAGE DASHBOARD</span>
            </a>
        </div>
        <p class="token navbar-text navbar-right">Please authenticate</p>
        <p class="navbar-text navbar-right"><a class="connect navbar-link">Connect</a></p>
    </div>
</nav>
<div class="container-fluid dashboard">
    <div class='row'>
        <div class='col-md-3'>
            <div class="form-group row">
                <label for="summits" class="col-md-3 col-form-label">Summit</label>
                <div class="col-md-9">
                    <select id="summits" class="selectpicker form-control" title="No summits" disabled></select>
                </div>
            </div>
            <div class="form-group row">
                <label for="locations" class="col-md-3 col-form-label">Location</label>
                <div class="col-md-9">
                    <select id="locations" class="selectpicker form-control" title="No locations" data-live-search="true" disabled></select>
                </div>
            </div>
            <div class="form-group row">
                <label for="template" class="col-md-3 col-form-label">Template</label>
                <div class="col-md-9">
                    <select id="template" class="selectpicker form-control" disabled>
                        <!-- <option value="schedule">Schedule</option> -->
                        <!-- <option value="schedule-mint">Schedule Mint</option> -->
                        <option value="banner">Static Message</option>
                        <option value="image">Static Image</option>
                        <option value="image-landscape">Static Image Landscape</option>
                        <!--<option value="ocp-2019-breakout-rooms">OCP 2019 Breakout Rooms</option>
                        <option value="ocp-2019-expo-hall-talks">OCP 2019 Expo Hall Talks</option>-->
                        <option value="ocp-2019-ams-exec-tracks-portrait">OCP 2019 AMS Executive Tracks Portrait</option>
                        <option value="ocp-2019-ams-exec-tracks-landscape">OCP 2019 AMS Executive Tracks Landscape</option>
                        <!-- <option value="ocp-ams-meeting">OCP AMS Meeting Room</option> -->
                        <!-- <option value="ocp-ams-content">OCP AMS Content (Program)</option> -->
                        <!-- <option value="ocp-ams-signage">OCP AMS Signage (You are in)</option> -->
                        <!-- <option value="ocp-ams-fnsign">OCP AMS FNSign</option> -->
						<option value="ocp-ams-image">OCP AMS Static Image</option>
						<option value="ocp-ams-image-g001">OCP AMS Static Image G001</option>
						<option value="ocp-ams-image-g001v2">OCP AMS Static Image G001v2</option>
						<option value="ocp-ams-image-g002">OCP AMS Static Image G002</option>
						<option value="ocp-ams-image-g003">OCP AMS Static Image G003</option>
						<option value="ocp-ams-image-g101">OCP AMS Static Image G101</option>
						<option value="ocp-ams-image-g108">OCP AMS Static Image G108</option>
						<option value="ocp-ams-image-g109">OCP AMS Static Image G109</option>
						<option value="ocp-ams-image-g110">OCP AMS Static Image G110</option>
						<option value="ocp-ams-image-g111">OCP AMS Static Image G111</option>
						<option value="ocp-ams-image-landscape">OCP AMS Static Image Landscape</option>
                        <!-- <option value="oculus-oc5-signage">OC5 OCULUS Signage</option>
                        <option value="oculus-oc5-registration">OC5 OCULUS Registration</option> -->
                        <option value="oculus-oc6-sessions">Oculus OC6 Sessions</option>
						<option value="oculus-oc6-schedule">Oculus OC6 Schedule</option>
						<!-- <option value="oc6-oculus-signage">OC6 Oculus Signage</option>
						<option value="oc6-oculus-signage-220b">OC6 Oculus Signage 220b</option>
						<option value="oc6-oculus-signage-220c">OC6 Oculus Signage 220c</option>
						<option value="oc6-oculus-signage-210f">OC6 Oculus Signage 210f</option>
						<option value="oc6-oculus-signage-210h">OC6 Oculus Signage 210h</option>
						<option value="oc6-oculus-signage-sp">OC6 Oculus Signage sp</option>
						<option value="oc6-oculus-signage-tt">OC6 Oculus Signage tt</option> -->
                        <option value="oc6-oculus-image-eod1">OC6 EOD Image Day 1</option>
                        <option value="oc6-oculus-image-eod2">OC6 EOD Image Day 2</option>
                        <option value="oc6-oculus-image-sessionfull">OC6 Image Session Full</option>
                        <!--<option value="f8-schedule">F8 Schedule</option>
                        <option value="f8-sessions">F8 Today's Sessions</option>-->
                    </select>
                </div>
            </div>
            <div class="form-group row">
                <label for="background" class="col-md-3 col-form-label">Background</label>
                <div class="col-md-9">
                    <select id="background" class="selectpicker form-control" disabled>
                        <option value="assets/images/f8-2019/still-blue.jpeg">Still Blue</option>
                        <option value="assets/images/f8-2019/still-green.jpeg">Still Green</option>
                        <option value="assets/images/f8-2019/still-baloons.jpeg">Still Baloons</option>
                        <option value="assets/images/f8-2019/still-sessions.jpg">Still Today's Sessions</option>
						<option value="assets/images/OC6_FNSIGN_Bkgd_LMU_edit.png">OC6 2019</option>
                        <option value="">None (Black background)</option>
                    </select>
                </div>
            </div>
        </div>
        <div class='col-md-3'>
            <div class="form-group row">
                <label for="jump-date" class="col-md-3 col-form-label">DateTime</label>
                <div class="col-md-9">
                    <div class='input-group date' id="jump-date" aria-describedby="jump date">
                        <input type='text' class="form-control" name="jump_date" disabled/>
                        <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-md-5 col-md-offset-3">
                    <button id="btn-jump" type="button" class="btn btn-primary" disabled>Jump</button>
                </div>
            </div>
        </div>
        <form id="static-banner">
            <input type="hidden" name="id" value="0">
            <input type="hidden" name="class_name" value="SummitLocationBanner">
            <input type="hidden" name="title" value="Static Banner"/>
            <input type="hidden" name="type" value="Primary">
            <input type="hidden" name="enabled" value="1">
            <div class="col-md-4">
                <div class="form-group row">
                    <div class="col-md-9">
                        <textarea class="form-control" name="content" rows="1" aria-describedby="static message content" placeholder="Enter static message text." title="Click Save to add message. To delete your message, delete all text then click Save." disabled></textarea>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary" aria-describedby="message submit" disabled>Save</button>
                    </div>
                </div>
            </div>
        </form>
        <div class="col-md-2">
            <div class="form-group row">
                <div class="col-md-offset-3 col-md-9">
                    <button id="btn-view" type="button" class="btn btn-secondary" disabled>View Sign</button>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-md-offset-3 col-md-9">
                    <button id="btn-reset" type="button" class="btn btn-secondary" disabled>Push Updates</button>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-md-offset-3 col-md-9">
                    <button id="btn-view-background" type="button" class="btn btn-secondary" disabled>View Background</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class='col-md-3'>
            <div class="form-group row">
                <label for="view" class="col-md-3 col-form-label">View</label>
                <div class="col-md-9">
                    <select id="view" class="selectpicker form-control" disabled>
                        <option value="events" selected>Events</option>
                        <option value="banners">Messages</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="events" style="display: none;">
    <table id="grid-data-events" data-ajax="true" class="table table-condensed table-hover table-striped grid-margin">
        <thead>
        <tr>
            <th data-column-id="id" data-type="numeric" data-converter="numeric" data-identifier="true" data-header-css-class="eventColumn">ID</th>
            <th data-column-id="title" searchable="true" data-formatter="eventtitle" data-header-css-class="titleColumn">Event Title</th>
            <th data-column-id="speakers" data-formatter="csvspeakers" data-sortable="false" data-header-css-class="speakersColumn">Speakers</th>
            <th data-column-id="floorroom" data-formatter="floorroom" data-header-css-class="floorRoomColumn" data-sortable="false">Floor / Location</th>
            <th data-column-id="tags" data-formatter="csvtags" data-sortable="false" data-header-css-class="tagsColumn">Tags</th>
            <th data-column-id="start_date" data-formatter="date" data-sortable="true" data-header-css-class="dateColumn">Start date</th>
            <th data-column-id="end_date" data-formatter="date" data-sortable="true" data-header-css-class="dateColumn">End date</th>
            <th data-column-id="event_actions" data-formatter="event_actions" data-header-css-class="screenLinkColumn" data-sortable="false">Actions</th>
        </tr>
        </thead>
    </table>
</div>
<div id="banners" style="display: none;">
    <table id="grid-data-banners" data-ajax="true" class="table table-condensed table-hover table-striped grid-margin">
        <thead>
        <tr>
            <th data-column-id="id" data-type="numeric" data-converter="numeric" data-identifier="true" data-header-css-class="messageColumn">ID</th>
            <th data-column-id="title" searchable="true" data-formatter="bannertitle" data-header-css-class="speakersColumn">Message Title</th>
            <th data-column-id="content" searchable="true" data-formatter="bannercontent" data-header-css-class="titleColumn">Message Content</th>
            <th data-column-id="banner_type" data-formatter="bannertype" data-sortable="true" data-header-css-class="dateColumn">Type</th>
            <th data-column-id="floorroom" data-formatter="floorroom" data-header-css-class="floorRoomColumn" data-sortable="false">Floor / Location</th>
            <th data-column-id="start_date" data-formatter="date" data-sortable="true" data-header-css-class="dateColumn">Start date</th>
            <th data-column-id="end_date" data-formatter="date" data-sortable="true" data-header-css-class="dateColumn">End date</th>
            <th data-column-id="banner_actions" data-formatter="banner_actions" data-header-css-class="screenLinkColumn" data-sortable="false">Actions</th>
        </tr>
        </thead>
    </table>
    <div class="container-fluid">
        <div class="row">
            <div class='col-md-2'>
                <button class="btn btn-default" type="button" data-toggle="modal" data-target="#banner-dialog" data-action="create">New Message</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" charset="utf-8">

    $( document ).ready(function() {

        // halt if running in iframe
        if (window.self !== window.top)
            return;

        let backgroundTemplates = ["fnopen-f8-schedule", "fnopen-f8-sessions", "banner"]
        let scheduleTemplates = ["fnopen-f8-schedule", "fnopen-f8-sessions"];
        let bannerTemplates = ["banner"];

        var timeZone = "UTC";
        let timePickerDateFormat = 'YYYY-MM-DD HH:mm';

        configureJumpTimeControls(false);

        autosize($("#static-banner textarea"));

        const db = firebase.initializeApp({

            apiKey: adminFirebaseConfig.FIREBASE_API_KEY,
            authDomain: adminFirebaseConfig.FIREBASE_AUTH_DOMAIN,
            projectId: adminFirebaseConfig.FIREBASE_PROJECT_ID,
            databaseURL: adminFirebaseConfig.FIREBASE_DATABASE_URL,
            
        }).database();

        $('#btn-view').on('click', function(e) {

            window.open($('#template').val() + '.html#/?summit=' + $('#summits').val() + '&location=' + $('#locations').val())
        });

        $('#btn-view-background').on('click', function(e) {
            
	       window.open('/' + $('#background').val())
        }); 	    

        $('#btn-reset').on('click', function(e) {

            firebaseUpdate('reload', $('#locations').val())
        });

        $('#btn-jump').on('click', function(e) {

            let date = moment.tz($('#jump-date input').val(), 'Y-M-D HH:mm', timeZone);

            if ( ! date.isValid()) {
                return alert('Invalid date')
            }

            firebaseUpdate('time', $("#locations").val() + '&' + date.unix());
        });

        let firebaseUpdate = function(field, value) {

            // We need the value to *change* so clear it first.
            firebaseLogin().then(function() {

                return db.ref(field).set('').then(function() {

                    return db.ref(field).set(value)
                })

            }).catch(function() {

                alert("Error accessing Firebase database");
            })
        };

        let firebaseObjectPushValueForKey = function(obj, key, value) {

            firebaseLogin().then(function() {

                return db.ref(obj).once('value').then(function(snapshot) {

                    let obj = {};

                    if (snapshot.exists()) {

                        let decoded = atob(snapshot.val());

                        obj = JSON.parse(decoded);
                    }

                    Object.keys(obj).forEach(function (key) {

                        obj[key] = obj[key].filter(item => item !== value);
                    });

                    if (!(key in obj)) {

                        obj[key] = []
                    }

                    obj[key].push(value);

                    let encoded = btoa(JSON.stringify(obj));

                    snapshot.ref.set(encoded)

                }, function(error) {

                    console.error(error);
                });

            }).catch(function() {

                alert("Error accessing Firebase database");
            })
        };


        let firebaseObjectGetKeyForValue = function(obj, value) {

            return new Promise(function(resolve, reject) {

                firebaseLogin().then(function() {

                    return db.ref(obj).once('value').then(function(snapshot) {

                        let obj = {};

                        if (snapshot.exists()) {

                            let decoded = atob(snapshot.val());

                            obj = JSON.parse(decoded);
                        }

                        Object.keys(obj).forEach(function (key) {

                            if (obj[key].includes(value)) {

                                resolve(key)
                            }
                        });

                        reject();

                    }, function(error) {

                        reject(error);

                        console.error(error);
                    });

                }).catch(function() {

                    alert("Error accessing Firebase database");
                })
            })
        }

        let firebaseLogin = function() {

            return new Promise(function(resolve, reject) {

                if (firebase.auth().currentUser) {

                    return resolve()
                }

				firebase.auth().signInAnonymously().then(function() {

					resolve();

				}).catch(function(error) {

					var errorCode = error.code;
					var errorMessage = error.message;

					reject();
				});

                /*let dialog = $("#firebase-dialog");
                let username = dialog.find("input[name=username]");
                let password = dialog.find("input[name=password]");

                username.val("");
                password.val("");

                dialog.modal('show');

                dialog.find("form").on("submit", function(ev) {

                firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
                  .then(function() {
                    // Existing and future Auth states are now persisted in the current
                    // session only. Closing the window would clear any existing state even
                    // if a user forgets to sign out.
                    // ...
                    // New sign-in will be persisted with session persistence.

                        firebase.auth().signInWithEmailAndPassword(

                            username.val(),
                            password.val()

                        ).then(function() {

                            dialog.modal("hide");
	                    resolve();     

                        }).catch(function(err) {
     
                            alert('Firebase: ' + err.message);
                            username.focus();
	            	    reject();    
    			});

                  })
                  .catch(function(error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                   });

                    ev.preventDefault();
                });

                dialog.on('hidden.bs.modal', function(e) {

                    if (firebase.auth().currentUser) {

                        return resolve()
                    }

                    reject()
                });*/
            })
        };

        var conventionCenter = null;

        let spanWithTooltips = function(text) {

            return "<span title='"+ text + "'>"+text+"</span>";
        };

        let extractToken = function() {

            let uri = new URI();
            return URI.parseQuery(uri.fragment()).access_token;
        };

        let extractSummitID = function() {

            return $("#summit_id").val();
            /*
            var uri = new URI();
            return URI.parseQuery(uri.query()).summit_id;
            */
        };

        let extractLocationID = function() {

            return $("#location_id").val();
            /*
            var uri = new URI();
            return URI.parseQuery(uri.query()).location_id;
            */
        };

        var lastApiCall = null;

        let setRequestHeaders = function (xhr) {

            xhr.setRequestHeader("Authorization", "Bearer " + unescape(token));
            xhr.setRequestHeader("Accept", "application/json");
            xhr.setRequestHeader("Content-Type", "application/json");

            lastApiCall = this;
        };

        let fillSummitList =  function() {

            $("#summits")
                .selectpicker({"title": "Loading summits..."})
                .selectpicker('refresh');

            $.ajax({
                url: summits_resource,
                type: "GET",
                contentType: "application/json; charset=utf-8",
                beforeSend: setRequestHeaders,
                success: function (response, textStatus, jqXHR ) {

                    let data = response.data.reverse();

                    if (data.length) {

                        $("#summits").empty();
                        $("#summits").prop("disabled", false);

                        $.each(data, function(index, value) {

                            $('<option/>', {
                                text: value.name,
                                value: value.id,
                                data: {
                                    time_zone: value.time_zone.name,
                                    start_date: value.start_date,
                                    end_date: value.end_date
                                }
                            }).appendTo($("#summits"));

                        });

                        $("#summits > option:first-child").attr("selected", "selected");
                        $("#summits").selectpicker('refresh');
                        $("#summits").change();

                    } else {
                        
                        $("#summits").empty()
                            .selectpicker({"title": "No summits"})
                            .selectpicker('refresh');
                    }
                },
                error:function (jqXHR, textStatus, errorThrown ) {

                    console.log(errorThrown);
                }
            });
        };

        let fillLocationList =  function(summit_id) {

            let locations = $("#locations");

            locations.prop("disabled", true);
            locations.empty()
                .selectpicker({"title": "Loading locations..."})
                .selectpicker('refresh');

            $.ajax({
                url: locations_resource.replace("{summit_id}", summit_id),
                type: "GET",
                contentType: "application/json; charset=utf-8",
                beforeSend: setRequestHeaders,
                success: function (response, textStatus, jqXHR ) {

                    locations.empty();

                    var venues = response.data.filter(function (el) {

                        return el.class_name == 'SummitVenue';
                    });

                    conventionCenter = venues[0];

                    $.each(venues, function(index, value) {

                        let venue = $("<option></option>")
                            .attr("value", 0)
                            .text("All " + value.name + " Locations")
                            .data("content", "All <span style='font-style: italic;'>" + value.name + "</span> Locations");

                        locations.append(venue);

                        if (value.rooms != null) {

                            if (value.floors != null) {

                                let sortedFloors = value.floors.sort(function(x, y) { return x.number > y.number });

                                $.each(sortedFloors, function(floor_idx, floor_value) {

                                    let floor = $("<optgroup></optgroup>")
                                        .attr("label", floor_value.name);

                                    let floorRooms =
                                        $.grep(value.rooms, function(n, i) {
                                            return n.floor_id == floor_value.id;
                                        });

                                    $.each(floorRooms, function(room_idx, room_value) {

                                        let room = $("<option></option>")
                                            .attr("value", room_value.id)
                                            .text(room_value.name)
                                            .attr("data-subtext", '- ' + room_value.id)
                                            .attr("data-tokens", [floor_value.number, floor_value.name].join(' '));

                                        floor.append(room);
                                    });

                                    floor.html(floor.children("option").sort(function (x, y) {
                                        return $(x).text().toUpperCase() < $(y).text().toUpperCase() ? -1 : 1;
                                    }));

                                    locations.append(floor);
                                });

                            } else {

                                let floor = $("<optgroup></optgroup>").attr("label", " ");

                                $.each(value.rooms, function(room_idx, room_value) {

                                    let room = $("<option></option>")
                                        .attr("value", room_value.id)
                                        .text(room_value.name);

                                    floor.append(room);
                                });

                                floor.html(floor.children("option").sort(function (x, y) {
                                    return $(x).text().toUpperCase() < $(y).text().toUpperCase() ? -1 : 1;
                                }));

                                locations.append(floor);
                            }
                        }
                    });

                    locations.prop("disabled", false);
                    locations
                        .selectpicker({"title": "Please select a location"})
                        .selectpicker('refresh');

                },
                error:function (jqXHR, textStatus, errorThrown ) {

                    locations.empty()
                        .selectpicker({"title": "No locations"})
                        .selectpicker('refresh');
                        
                    console.log(errorThrown);
                }
            });
        };

        let getStaticBanner = function() {

            let url = banners_resource.replace('{summit_id}', $("#summits").val()).replace('{location_id}', $("#locations").val());

            $.ajax({
                url: url,
                type: "GET",
                    beforeSend: setRequestHeaders,
                data: {
                    "filter": "class_name==SummitLocationBanner",
                },
            })
                .done(function(data, textStatus, jqXHR) {

                    let content = $('#static-banner textarea[name=content]');

                    if (data.data.length) {

                        let staticBanners = data.data.filter(function(banner) {
                            return banner.class_name == 'SummitLocationBanner';
                        });

                        if (staticBanners.length) {

                            let message = staticBanners[0];

                            $('#static-banner input[name=id]').val(message.id);

                            content.val(message.content);

                            autosize.update(content);
                        }
                    }

                    content.prop("disabled", false);
                    $('#static-banner button').prop("disabled", false);
                })
                .fail(function(jqXHR, textStatus, errorThrown) {

                    console.log("HTTP Request Failed");
                })
                .always(function() {
                    /* ... */
                });
        };

        let createOrUpdateBanner = function(payload) {

            let posfix = payload.id != 0 ? "/" + payload.id : "";
            let method = payload.id != 0 ? "PUT" : "POST";

            delete payload["id"];

            $.ajax({
                url: banners_resource.replace('{summit_id}', $("#summits").val()).replace('{location_id}', $("#locations").val()) + posfix,
                type: method,
                contentType: "application/json; charset=utf-8",
                beforeSend: setRequestHeaders,
                dataType: "json",
                data: JSON.stringify(payload),
            })
                .done(function(data, textStatus, jqXHR) {

                    console.log("HTTP Request Succeeded: " + jqXHR.status);
                    console.log(data);
                })
                .fail(function(jqXHR, textStatus, errorThrown) {

                    console.log("HTTP Request Failed");
                    alert(jqXHR.responseText);
                })
                .always(function() {

                    if (payload.class_name == "ScheduledSummitLocationBanner") {

                        if (scheduleTemplates.includes($("#template").val())) {

                            firebaseUpdate('reload', $('#locations').val())
                        }
                        $("#view").change();

                    } else {

                        if (bannerTemplates.includes($("#template").val())) {

                            firebaseUpdate('reload', $('#locations').val())
                        }
                        getStaticBanner();
                    }
                });
        };

        let deleteBanner = function(id) {

            $.ajax({
                url: banners_resource.replace('{summit_id}', $("#summits").val()).replace('{location_id}', $("#locations").val()) + '/' + id,
                type: "DELETE",
                contentType: "application/json; charset=utf-8",
                beforeSend: setRequestHeaders,
            })
                .done(function(data, textStatus, jqXHR) {

                    console.log("HTTP Request Succeeded: " + jqXHR.status);
                    console.log(data);
                })
                .fail(function(jqXHR, textStatus, errorThrown) {

                    console.log("HTTP Request Failed");
                    alert(jqXHR.responseText);
                })
                .always(function() {

                    let saveButton = $('#static-banner button');

                    if (saveButton.prop("disabled") == true) {

                        if (bannerTemplates.includes($("#template").val())) {

                            firebaseUpdate('reload', $('#locations').val())
                        }

                        saveButton.prop("disabled", false);

                        let content = $('#static-banner textarea[name=content]');
                        content.prop("disabled", false);

                        autosize.update(content);

                    } else {

                        if (scheduleTemplates.includes($("#template").val())) {

                            firebaseUpdate('reload', $('#locations').val())
                        }
                        $("#view").change();
                    }
                });
        };


        var idp_host = adminConfig.IDP_HOST;
        var resource_server_host = adminConfig.RESOURCE_SERVER_HOST;
        var client_id = adminConfig.CLIENT_ID;

        let setting =
            {
                'host': idp_host,
                'rserver_host': resource_server_host,
                'clientId': client_id,
                'scopes':   'https://' + resource_server_host + '/summits/read ' +
                'https://' + resource_server_host + '/locations/banners/write'
            };

        //these values might be taken from query string, however auth2 redirection is not returning second parameter
        let summit_id = extractSummitID();
        let location_id = extractLocationID();

        let authHost     = "https://" + setting.host;
        let summits_resource = "https://" + setting.rserver_host + "/api/v1/summits";
        let locations_resource = "https://" + setting.rserver_host + "/api/v1/summits/{summit_id}/locations?page=1&per_page=100";
        let summit_events_resource = "https://" + setting.rserver_host + '/api/v1/summits/{summit_id}/events/published';
        let events_resource = "https://" + setting.rserver_host + '/api/v1/summits/{summit_id}/locations/{location_id}/events/published';
        let banners_resource = "https://" + setting.rserver_host + '/api/v1/summits/{summit_id}/locations/{location_id}/banners';
        let endUserAuthorizationEndpoint = authHost + "/oauth2/auth";


        var token = extractToken();

        let authUrl = endUserAuthorizationEndpoint +
            "?response_type=token id_token" +
            "&scope=" + encodeURI(setting.scopes) +
            "&client_id="  + encodeURI(setting.clientId) +
            "&redirect_uri=" + URI().fragment("").toString();

        $("a.connect").attr("href", authUrl + "&approval_prompt=force");

        $("#summits").on('change', function() {

            $("#events, #banners").hide();

            configureJumpTimeControls(false);

            $("#btn-jump").prop("disabled", true);
            $("#btn-view").prop("disabled", true);
            $("#btn-reset").prop("disabled", true);
            $("#btn-view-background").prop("disabled", true);

            $("#template").prop("disabled", true);
            $("#template").val(scheduleTemplates[0]);
            $("#template").selectpicker("refresh");

            $("#background").prop("disabled", true);
            $("#background").val(backgroundTemplates[0]);
            $("#background").selectpicker("refresh");

            $("#view").prop("disabled", true);
            $("#view > option:first-child").attr("selected", "selected");
            $("#view").selectpicker('refresh');

            initializeBannerModal();

            fillLocationList(this.value);
        });

        $("#locations").on('change', function() {

            configureJumpTimeControls(true);

            $("#btn-jump").prop("disabled", false);
            $("#btn-view").prop("disabled", false);
            $("#btn-reset").prop("disabled", false);
            $("#btn-view-background").prop("disabled", true);

            $('#static-banner input[name=id]').val(0);

            let content = $('#static-banner textarea[name=content]');
            content.val("");
            content.prop("disabled", true);
            autosize.update(content);

            $('#static-banner button').prop("disabled", true);

            if (this.value != 0) {

                getStaticBanner();
            }            

            $("#template").prop("disabled", true);
            $("#template").val(scheduleTemplates[0]);
            $("#template").selectpicker("refresh");

            $("#background").prop("disabled", true);
            $("#background").val(backgroundTemplates[0]);
            $("#background").selectpicker("refresh");

            firebaseObjectGetKeyForValue('template-base64-object', $('#locations').val()).then(function(template) {

                if ($('#locations').val() != 0) {

                    $("#template").prop("disabled", false);
                    $("#template").val(template);
                    $("#template").selectpicker('refresh');

                    updateBackgroundDropDown(template);
                }

            }).catch(function(error) {

                if (error == null) {

                    let template = scheduleTemplates[0];

                    $("#template").prop("disabled", false);
                    $("#template").val(template);
                    $("#template").selectpicker("refresh");
                    $("#template").change();
                }
            })

            $("#view option[value='banners']").prop("disabled", this.value == 0 ? true : false);
            $("#view").prop("disabled", false);
            $("#view").selectpicker("refresh");
            $("#view").change();
        });

        $("#template").on('change', function() {

            let template = this.value;

            firebaseObjectPushValueForKey('template-base64-object', template, $('#locations').val());

            updateBackgroundDropDown(template);
        });

        let updateBackgroundDropDown = function(template) {

            let isBackgroundTemplate = backgroundTemplates.includes(template)

            firebaseObjectGetKeyForValue('background-base64-object', $('#locations').val()).then(function(background) {

                if ($('#locations').val() != 0) {

                    if (isBackgroundTemplate) {

                        $("#background").prop("disabled", false);
                        $("#background").val(background);

                    } else {

                        $("#background").prop("disabled", true);
                        $("#background option:eq(0)").prop("selected", true);
                    }

                    $("#background").selectpicker("refresh");

                    $("#btn-view-background").prop("disabled", !isBackgroundTemplate);
                }

            }).catch(function(error) {

                if (error == null) {

                    $("#background").prop("disabled", !isBackgroundTemplate);
                    $("#background option:eq(0)").prop("selected", true);
                    $("#background").selectpicker("refresh");

                    if (isBackgroundTemplate) $("#background").change();

                    $("#btn-view-background").prop("disabled", !isBackgroundTemplate);
                }
            })
        } 

        $("#background").on('change', function() {

            firebaseObjectPushValueForKey('background-base64-object', this.value, $('#locations').val());
        });

        $("#view").on('change', function() {

            let grid = this.value;

            if (grid === "events") {

                $("#banners").hide();
                $("#events").show();

                $("#grid-data-events").bootgrid("destroy");

                $("#view").prop(
                    "disabled", isNaN(parseInt($('#locations').val()))
                );

                if ($('#locations').val() === '0') {

                    return initializeEventsGrid(summit_events_resource.replace(
                        '{summit_id}', $("#summits").val()
                    ))
                }

                let new_url = events_resource.replace('{summit_id}', $("#summits").val()).replace('{location_id}', $("#locations").val());

                initializeEventsGrid(new_url);

            } else if (grid === "banners") {

                $("#events").hide();
                $("#banners").show();

                $("#grid-data-banners").bootgrid("destroy");

                if ($('#locations').val() === '0') {

                    return;
                }

                let new_url = banners_resource.replace('{summit_id}', $("#summits").val()).replace('{location_id}', $("#locations").val());

                initializeBannersGrid(new_url);
            }
        });

        if (token) {

            $('p.token').text("You are authenticated");
            $("a.connect").text('Re-connect');

            fillSummitList();
        }

        let refreshToken = function() {

            token = null;

            return new Promise(function(resolve, reject) {

                reject()

                /*(function(e, s) {

                    e.id = 'inception';

                    e.src = s;

                    e.style = 'display: none;';

                    e.onload = function() {

                        let uri = new URI(document.getElementById("inception").contentWindow.location.href);

                        token = URI.parseQuery(uri.fragment()).access_token;

                        if (token != null) {

                            window.location.hash = uri.fragment();

                            resolve();
                        }
                        else {

                            reject()
                        }

                        document.body.removeChild(e);
                    };

                    document.body.appendChild(e);

                })(document.createElement('iframe'), authUrl);*/
            })
        };

        $(document).ajaxError(function(event, jqXHR, settings, thrownError) {

            // Unauthorized

            if (jqXHR.status == 401) {

                refreshToken().then(function() {

                    if (lastApiCall != null) {

                        $.ajax(lastApiCall);
                    }

                }).catch(function(err) {

                    alert("Last api call failed. Please Re-Connect");

                    console.log(err);
                })
            }
        });

        function configureJumpTimeControls(enabled) {

            let jumpTimePicker = $("#jump-date");
            let input = jumpTimePicker.find("input");

            let now = moment().format(timePickerDateFormat);
            input.val(now);

            if (enabled) {

                input.prop("disabled", false);
                jumpTimePicker.find("span").css("cursor", "pointer");
                jumpTimePicker.datetimepicker({ initialDate: now });
            }
            else {

                input.prop("disabled", true);
                jumpTimePicker.find("span").css("cursor", "not-allowed");
                jumpTimePicker.datetimepicker("remove");
            }
        }

        function initializeBannerModal() {

            // Configure global time zone
            // and banner dialog date pickers

            let summitSelected = $("#summits > option:selected");

            timeZone = summitSelected.data("time_zone");

            let startDate = summitSelected.data("start_date");
            let endDate = summitSelected.data("end_date");

            var options = {
                startDate: moment.unix(startDate).tz(timeZone).format(timePickerDateFormat),
                endDate: moment.unix(endDate).tz(timeZone).format(timePickerDateFormat),
            };

            options.initialDate = options.startDate;

            let startTimePicker = $("#banner-start");
            startTimePicker.datetimepicker("remove");
            startTimePicker.datetimepicker(options);
            startTimePicker.data("startDate", options.startDate);

            options.initialDate = options.endDate;

            let endTimePicker = $("#banner-end");
            endTimePicker.datetimepicker("remove");
            endTimePicker.datetimepicker(options);
            endTimePicker.data("startDate", options.endDate);
        }

        function cleanBannerModal() {

            let modal = $("#banner-dialog");

            modal.find('.modal-body input[name=id]').val(0);
            modal.find('.modal-body input[name=title]').val("");
            modal.find('.modal-body textarea[name=content]').val("");
            modal.find('.modal-body select > option:first-child').prop("selected", true);

            let startInput = modal.find('.modal-body input[name=start_date]');
            startInput.val(startInput.parent().data("startDate"));

            let endInput = modal.find('.modal-body input[name=end_date]');
            endInput.val(endInput.parent().data("startDate"));
        }

        function initializeEventsGrid(url) {

            $("#grid-data-events").bootgrid({

                ajax: true,
                ajaxSettings: {

                    method: "GET",
                    cache: false,
                    beforeSend: setRequestHeaders,
                },
                url: url,
                requestHandler: function (request) {

                    let title = $('#event_title').val().length ? 'title=@' + $('#event_title').val().trim() : '';
                    let keyword = $('#event_keyword').val().length ? 'tags=@' + $('#event_keyword').val().trim() : '';
                    let filters = (title.length && keyword.length ? [ title , keyword ] : keyword+ '' + title);
                    let isSorted = (request.sort);
                    let orderBy = '';

                    if (isSorted){

                        let order = Object.keys(request.sort)[0] || 'start_date';
                        let asc = request.sort[Object.keys(request.sort)[0]] || 'asc';
                        orderBy = (asc === 'asc' ?  '+' : '-') + order  ;

                        request = {
                            page: request.current,
                            per_page: request.rowCount,
                            order: orderBy,
                            expand: "speakers,location",
                        };

                    } else{

                        request = {
                            page: request.current,
                            per_page: request.rowCount
                        };
                    }

                    if (filters) request.filter = filters;

                    return request;
                },
                responseHandler: function (response) {

                    response = {
                        current: response.current_page,
                        rowCount: response.per_page,
                        rows: response.data,
                        total: response.total
                    };

                    return response;

                },
                formatters: {

                    eventtitle: function (column, row) {

                        return spanWithTooltips(row[column.id]);
                    },

                    csvspeakers: function (column, row) {

                        if (row[column.id]) {

                            let arr = jQuery.map( $(row[column.id]), function( speaker ) {
                                return speaker.first_name + ' ' + speaker.last_name;
                            });

                            return spanWithTooltips(arr.join(", "));

                        } else {

                            return "";
                        }
                    },

                    csvtags: function (column, row){

                        if (row[column.id]){

                            let arr = jQuery.map( $(row['tags']), function( tag ) {
                                return tag.tag;
                            });
                            return spanWithTooltips(arr.join(","));

                        } else {

                            return "";
                        }
                    },

                    floorroom: function(column, row) {

                        let floor = 'N/A';
                        let room = 'N/A';

                        if (row.location) {
                            room = row.location.name;

                            let f = (conventionCenter.floors || []).filter(function(f) {
                                return f.id === row.location.floor_id
                            }).shift();

                            if (f) { floor = f.name }
                        }

                        let title = floor + ' / ' + room;
                        return '<span title="' + title + '">' + title + '</span>';
                    },

                    event_actions: function (column, row) {

                        return '<button class="btn btn-primary btn-sm event-jump" data-ts="' + row.start_date + '">Jump</button>';
                    },

                    date: function(column, row){

                        let utc_date = row[column.id];
                        let date = moment.unix(utc_date);
                        return date.tz(timeZone).format('MM/DD HH:mm');
                    }
                },
                rowCount: [10, 25, 50, 100],
                templates: {
                    header:
                    "<div id=\"{{ctx.id}}\" class=\"{{css.header}}\">" +
                        "<div class=\"row\">" +
                            "<div class=\"col-md-12 form-inline actionBar\">" +
                                "<div class=\"wheel\"/>" +
                                "<input type='input' class='form-control search-field inline-space' placeholder='Title' id='event_title'>" +
                                "<input type='input' class='form-control search-field inline-space' id='event_keyword' placeholder='Tag keyword'>" +
                                "<p class=\"{{css.actions}}\"></p>" +
                            "</div>" +
                        "</div>" +
                    "</div>"
                },
                selection: false,
                multiSelect: false,

            }).on("selected.rs.jquery.bootgrid", function (e, rows) {

                console.log(rows);
                console.log("selected");

            }).on("deselected.rs.jquery.bootgrid", function (e, rows) {

                console.log("deselected");

            }).on("click.rs.jquery.bootgrid", function (e,columns,rows) {

                console.log("click");

            }).on("loaded.rs.jquery.bootgrid", function (e){

                $('.event-jump').on('click', e => {

                    firebaseUpdate('time',

                        $("#locations").val() + '&' + $(e.currentTarget).data('ts')
                    )
                });

                console.log("loaded");
            });
        }

        function initializeBannersGrid(url) {

            $("#grid-data-banners").bootgrid( {

                ajax: true,
                ajaxSettings: {
                    method: "GET",
                    cache: false,
                    beforeSend: setRequestHeaders,
                },
                url: url,
                requestHandler: function (request) {

                    let title = $('#banner_title').val().length ? 'title=@' + $('#banner_title').val().trim() : '';
                    let keyword = $('#banner_content').val().length ? 'content=@' + $('#banner_content').val().trim() : '';
                    let class_name = 'class_name==ScheduledSummitLocationBanner';
                    let filters = (title.length && keyword.length && class_name.length ? [ title , keyword, class_name ] : keyword+ '' + title+ '' + class_name);
                    let isSorted = (request.sort);
                    let orderBy = '';

                    if (isSorted) {

                        let order = Object.keys(request.sort)[0] || 'start_date';
                        let asc = request.sort[Object.keys(request.sort)[0]] || 'asc';
                        orderBy = (asc === 'asc' ?  '+' : '-') + order  ;

                        request = {
                            filter : filters,
                            page: request.current,
                            per_page: request.rowCount,
                            order: orderBy,
                            expand: "location",
                        };

                    } else {

                        request = {
                            filter: filters,
                            page: request.current,
                            per_page: request.rowCount
                        };
                    }

                    return request;
                },

                responseHandler:function (response) {

                    response = {
                        current: response.current_page,
                        rowCount: response.per_page,
                        rows: response.data,
                        total: response.total
                    };

                    return response;
                },

                formatters: {

                    bannertitle: function (column, row){
                        return spanWithTooltips(row[column.id]);
                    },

                    floorroom: function(column, row) {

                        let floor = 'N/A';
                        let room = 'N/A';

                        if (row.location) {

                            room = row.location.name;

                            let f = (conventionCenter.floors || []).filter(function(f) {
                                return f.id === row.location.floor_id
                            }).shift();

                            if (f) { floor = f.name }
                        }

                        let title = floor + ' / ' + room;
                        return '<span title="' + title + '">' + title + '</span>';
                    },

                    bannertype: function (column, row) {

                        return (row.type == "Primary") ? "Top message" : "Footer message";
                    },

                    banner_actions: function (column, row) {

                        let encoded = utf8_to_b64(JSON.stringify(row));

                        var actions = "<button class=\"btn btn-primary btn-sm inline-space event-jump\" data-ts=\"" + row.start_date + "\">Jump</button>";

                        actions +=
                            "<button type=\"button\" class=\"btn btn-default btn-sm inline-space banner-action\" data-action=\"edit\" data-base64=\"" + encoded + "\" data-target=\"#banner-dialog\" aria-label=\"Edit\">\n" +
                            "  <span class=\"glyphicon glyphicon-pencil\" aria-hidden=\"true\"></span>\n" +
                            "</button>";

                        actions +=
                            "<button type=\"button\" class=\"btn btn-default btn-sm banner-action\" data-action=\"delete\" data-identifier=\"" + row.id + "\" aria-label=\"Delete\">\n" +
                            "  <span class=\"glyphicon glyphicon-trash\" aria-hidden=\"true\"></span>\n" +
                            "</button>";

                        return actions;
                    },

                    date: function(column, row){

                        let utc_date = row[column.id];
                        let date = moment.unix(utc_date);
                        return date.tz(timeZone).format('MM/DD HH:mm');
                    }
                },
                rowCount: [10, 25, 50, 100],
                templates: {
                    header:
                    "<div id=\"{{ctx.id}}\" class=\"{{css.header}}\">" +
                        "<div class=\"row\">" +
                            "<div class=\"col-md-12 form-inline actionBar\">" +
                                "<div class=\"wheel\"/>" +
                                "<input type='input' class='form-control search-field inline-space' id='banner_title' placeholder='Title' >" +
                                "<input type='input' class='form-control search-field inline-space' id='banner_content' placeholder='Content'>" +
                                "<p class=\"{{css.actions}}\"></p>" +
                            "</div>" +
                        "</div>" +
                    "</div>"
                },
                selection: false,

            }).on("click.rs.jquery.bootgrid", function (e,columns,rows) {

                console.log("click");

            }).on("loaded.rs.jquery.bootgrid", function (e){

                $('.event-jump').on('click', e => {

                    firebaseUpdate('time',

                        $("#locations").val() + '&' + $(e.currentTarget).data('ts')
                    )
                });

                $('.banner-action').on('click', e => {

                    let target = $(e.currentTarget);

                    switch (target.data("action")) {

                        case "edit":

                            let encoded = target.data("base64");
                            let decoded = JSON.parse(b64_to_utf8(encoded));

                            if (decoded != null) {

                                let startDate = moment.unix(decoded.start_date);
                                let endDate = moment.unix(decoded.end_date);

                                let modal = $(target.data("target"));

                                modal.modal("show");
                                modal.find('.modal-title').text("Edit Message");
                                modal.find('.modal-body input[name=id]').val(decoded.id);
                                modal.find('.modal-body input[name=title]').val(decoded.title);
                                modal.find('.modal-body textarea[name=content]').val(decoded.content);
                                modal.find('.modal-body input[name=start_date]').val(startDate.tz(timeZone).format(timePickerDateFormat));
                                modal.find('.modal-body input[name=end_date]').val(endDate.tz(timeZone).format(timePickerDateFormat));
                                modal.find('.modal-body select > option[value="' + decoded.type + '"]').prop("selected", true);
                            }

                            break;

                        case "delete":

                            target.addClass("disabled");
                            deleteBanner(target.data('identifier'));
                            break;

                        default:
                            break;
                    }
                });
            });
        }

        $('#banner-dialog').on('show.bs.modal', function (event) {

            let button = $(event.relatedTarget);

            let action = button.data('action');

            if (action === "create") {

                cleanBannerModal();

                let modal = $(this);
                modal.find('.modal-title').text("New Message");
            }
        });

        $('#banner-dialog form').on('submit', function(ev) {

            let payload = $(this).serializeObject();

            let start_date = moment.tz(payload.start_date, timePickerDateFormat, timeZone);
            let end_date = moment.tz(payload.end_date, timePickerDateFormat, timeZone);

            payload.start_date = start_date.unix();
            payload.end_date = end_date.unix();

            // Perform api call
            createOrUpdateBanner(payload);

            $('#banner-dialog').modal('hide');

            ev.preventDefault();
        });

        $("#static-banner").on('submit', function(ev) {

            let payload = $(this).serializeObject();

            $('#static-banner button').prop("disabled", true);
            $('#static-banner textarea[name=content]').prop("disabled", true);

            if (payload.id != 0 && payload.content == "") {

                $('#static-banner input[name=id]').val(0);

                deleteBanner(payload.id);

            } else {

                createOrUpdateBanner(payload);
            }

            ev.preventDefault();
        });

        $(document).on({

            ajaxStart: function() { $(".glyphicon-refresh").addClass("wheel-loading"); },
            ajaxStop: function() { $(".glyphicon-refresh").removeClass("wheel-loading"); }
        });
    });

    function utf8_to_b64( str ) {
        return window.btoa(unescape(encodeURIComponent(str)));
    }

    function b64_to_utf8( str ) {
        return decodeURIComponent(escape(window.atob(str)));
    }
</script>
</body>
</html>
